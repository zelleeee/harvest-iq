{% extends 'base.html' %}
{% block title %}Manage Orders{% endblock %}
{% block content %}
<div class="container py-4">
  <h2 class="fw-bold mb-4">ðŸ“‹ Manage Orders</h2>

  {% if orders %}
  <div class="d-flex flex-column gap-3">
    {% for order in orders %}
    <div class="card border-0 shadow-sm" style="border-radius:14px">
      <div class="card-body">
        <div class="d-flex justify-content-between flex-wrap gap-2 mb-3">
          <div>
            <span class="fw-bold">Order #{{ order.id }}</span>
            <span class="text-muted small ms-2">{{ order.created_at.strftime('%b %d, %Y') }}</span>
            <span class="ms-2 text-muted small">by <strong>{{ order.buyer.full_name or order.buyer.username }}</strong></span>
          </div>
          <span class="badge px-3 py-2
            {% if order.status == 'delivered' %}bg-success
            {% elif order.status == 'cancelled' %}bg-danger
            {% elif order.status == 'pending' %}bg-warning text-dark
            {% else %}bg-primary{% endif %}">
            {{ order.status | title }}
          </span>
        </div>

        <!-- Farmer's items in this order -->
        {% set farmer_items = order.items | selectattr('product.farmer_id', 'eq', current_user.id) | list %}
        <div class="d-flex gap-2 mb-3 flex-wrap">
          {% for item in farmer_items %}
          <div class="d-flex align-items-center gap-2 bg-light rounded-3 px-2 py-1">
            <img src="{{ url_for('static', filename='images/' + item.product.image) }}"
                 width="32" height="32" class="rounded" style="object-fit:cover"
                 onerror="this.src='https://images.unsplash.com/photo-1542838132-92c53300491e?w=32&h=32&fit=crop'"/>
            <span class="small">{{ item.product.name }} Ã—{{ item.quantity }}</span>
            <span class="small fw-semibold text-success">â‚±{{ "%.2f"|format(item.subtotal) }}</span>
          </div>
          {% endfor %}
        </div>

        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
          <div>
            <span class="text-muted small">Total: </span>
            <span class="fw-bold text-success">â‚±{{ "%.2f"|format(order.total_amount) }}</span>
            <span class="ms-2 badge {{ 'bg-success' if order.payment_status == 'paid' else 'bg-secondary' }}">
              {{ order.payment_status | title }}
            </span>
          </div>

          {% if order.status not in ['delivered', 'cancelled', 'refunded'] %}
          <form action="{{ url_for('orders.update_order_status', order_id=order.id) }}" method="POST" class="d-flex gap-2 align-items-center">
            <select class="form-select form-select-sm" name="status" style="width:auto">
              {% for s in ['confirmed', 'processing', 'shipped', 'delivered'] %}
              <option value="{{ s }}" {{ 'selected' if s == order.status }}>{{ s | title }}</option>
              {% endfor %}
            </select>
            <button type="submit" class="btn btn-success btn-sm">Update</button>
          </form>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="text-center py-5">
    <i class="fas fa-clipboard-list fa-4x text-muted mb-3 opacity-25"></i>
    <h4 class="text-muted">No orders yet</h4>
    <p class="text-muted">Orders for your products will appear here.</p>
  </div>
  {% endif %}
</div>
{% endblock %}