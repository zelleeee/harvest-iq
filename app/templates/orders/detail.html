{% extends 'base.html' %}
{% block title %}Order #{{ order.id }}{% endblock %}
{% block content %}
<div class="container py-4" style="max-width:800px">
  <div class="d-flex align-items-center gap-3 mb-4">
    <a href="{{ url_for('orders.my_orders') }}" class="btn btn-outline-secondary btn-sm"><i class="fas fa-arrow-left"></i></a>
    <h2 class="fw-bold mb-0">Order #{{ order.id }}</h2>
    <span class="badge px-3 py-2
      {% if order.status == 'delivered' %}bg-success
      {% elif order.status == 'cancelled' %}bg-danger
      {% elif order.status == 'pending' %}bg-warning text-dark
      {% elif order.status == 'shipped' %}bg-info text-dark
      {% else %}bg-primary{% endif %} ms-auto">
      {{ order.status | title }}
    </span>
  </div>

  <!-- Order Progress -->
  {% if order.status not in ['cancelled', 'refunded'] %}
  <div class="card border-0 shadow-sm mb-4" style="border-radius:14px">
    <div class="card-body py-4">
      {% set steps = ['pending', 'confirmed', 'processing', 'shipped', 'delivered'] %}
      {% set current_idx = steps.index(order.status) if order.status in steps else 0 %}
      <div class="d-flex justify-content-between align-items-center position-relative">
        <div class="progress-line"></div>
        {% for step in steps %}
        {% set idx = loop.index0 %}
        <div class="text-center" style="flex:1;position:relative;z-index:1">
          <div class="step-dot mx-auto {{ 'active' if idx <= current_idx else '' }}">
            {% if idx < current_idx %}✓{% elif idx == current_idx %}●{% else %}○{% endif %}
          </div>
          <div class="small mt-1 {{ 'text-success fw-semibold' if idx == current_idx else 'text-muted' }}">
            {{ step | title }}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}

  <div class="row g-3">
    <!-- Items -->
    <div class="col-md-7">
      <div class="card border-0 shadow-sm mb-3" style="border-radius:14px">
        <div class="card-header bg-transparent fw-bold border-0 pt-3">Order Items</div>
        <div class="card-body pt-0">
          {% for item in order.items %}
          <div class="d-flex align-items-center gap-3 py-2 {{ 'border-top' if not loop.first }}">
            <img src="{{ url_for('static', filename='images/' + item.product.image) }}"
                 width="60" height="60" class="rounded-3" style="object-fit:cover"
                 onerror="this.src='https://images.unsplash.com/photo-1542838132-92c53300491e?w=60&h=60&fit=crop'"/>
            <div class="flex-grow-1">
              <div class="fw-semibold">{{ item.product.name }}</div>
              <div class="text-muted small">{{ item.quantity }} {{ item.product.unit }} × ₱{{ "%.2f"|format(item.unit_price) }}</div>
            </div>
            <div class="fw-bold text-success">₱{{ "%.2f"|format(item.subtotal) }}</div>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Shipping Info -->
      <div class="card border-0 shadow-sm" style="border-radius:14px">
        <div class="card-header bg-transparent fw-bold border-0 pt-3">Delivery Information</div>
        <div class="card-body pt-1">
          <p class="mb-1 text-muted small"><strong>Address:</strong></p>
          <p class="mb-2">{{ order.shipping_address }}</p>
          <p class="mb-1 text-muted small"><strong>Payment Method:</strong> {{ order.payment_method | upper }}</p>
          {% if order.payment_reference %}
          <p class="mb-1 text-muted small"><strong>Reference:</strong> {{ order.payment_reference }}</p>
          {% endif %}
          {% if order.notes %}
          <p class="mb-0 text-muted small"><strong>Notes:</strong> {{ order.notes }}</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Summary -->
    <div class="col-md-5">
      <div class="card border-0 shadow-sm" style="border-radius:14px">
        <div class="card-header bg-transparent fw-bold border-0 pt-3">Order Summary</div>
        <div class="card-body">
          <div class="d-flex justify-content-between mb-2 small">
            <span>Subtotal ({{ order.item_count }} items)</span>
            <span>₱{{ "%.2f"|format(order.total_amount - order.delivery_fee) }}</span>
          </div>
          <div class="d-flex justify-content-between mb-2 small">
            <span>Delivery Fee</span>
            <span>{% if order.delivery_fee == 0 %}<span class="text-success">FREE</span>{% else %}₱{{ "%.2f"|format(order.delivery_fee) }}{% endif %}</span>
          </div>
          <hr/>
          <div class="d-flex justify-content-between fw-bold fs-5">
            <span>Total</span>
            <span class="text-success">₱{{ "%.2f"|format(order.total_amount) }}</span>
          </div>
          <div class="mt-2">
            <span class="badge {{ 'bg-success' if order.payment_status == 'paid' else 'bg-warning text-dark' }} w-100 py-2">
              Payment: {{ order.payment_status | title }}
            </span>
          </div>
          {% if order.payment_status == 'unpaid' and order.status not in ['cancelled'] %}
          <a href="{{ url_for('payment.process_payment', order_id=order.id) }}" class="btn btn-success w-100 mt-2">
            <i class="fas fa-credit-card me-2"></i>Pay Now
          </a>
          {% endif %}
          {% if order.status in ['pending', 'confirmed'] and order.buyer_id == current_user.id %}
          <form action="{{ url_for('orders.cancel_order', order_id=order.id) }}" method="POST"
                onsubmit="return confirm('Cancel this order?')">
            <button type="submit" class="btn btn-outline-danger w-100 mt-2">Cancel Order</button>
          </form>
          {% endif %}
        </div>
      </div>

      <div class="card border-0 shadow-sm mt-3 p-3" style="border-radius:14px">
        <div class="text-muted small">
          <div><strong>Order Date:</strong> {{ order.created_at.strftime('%b %d, %Y %I:%M %p') }}</div>
          <div class="mt-1"><strong>Last Updated:</strong> {{ order.updated_at.strftime('%b %d, %Y %I:%M %p') }}</div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.step-dot { width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.8rem;background:#e0e0e0;color:#999;font-weight:700; }
.step-dot.active { background:#2e7d32;color:white; }
.progress-line { position:absolute;top:16px;left:10%;right:10%;height:3px;background:#e0e0e0;z-index:0; }
</style>
{% endblock %}