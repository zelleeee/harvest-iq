{% extends 'base.html' %}
{% block title %}{{ product.name }}{% endblock %}
{% block content %}
<div class="container py-4">

  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}" class="text-success text-decoration-none">Home</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('products.list_products') }}" class="text-success text-decoration-none">Shop</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('products.list_products') }}?category={{ product.category_id }}" class="text-success text-decoration-none">{{ product.category.name }}</a></li>
      <li class="breadcrumb-item active">{{ product.name }}</li>
    </ol>
  </nav>

  <div class="row g-4">
    <!-- Product Image -->
    <div class="col-md-5">
      <div class="card border-0 shadow-sm overflow-hidden" style="border-radius:16px">
        <img src="{{ url_for('static', filename='images/' + product.image) }}"
             class="img-fluid w-100" style="height:380px;object-fit:cover"
             alt="{{ product.name }}"
             onerror="this.src='https://images.unsplash.com/photo-1542838132-92c53300491e?w=600&h=400&fit=crop'"/>
      </div>
      {% if product.is_organic %}
      <div class="mt-2"><span class="badge bg-success px-3 py-2 fs-6">üå± Certified Organic</span></div>
      {% endif %}
    </div>

    <!-- Product Info -->
    <div class="col-md-7">
      <div class="mb-1 text-muted small">{{ product.category.name }}</div>
      <h1 class="fw-bold mb-2">{{ product.name }}</h1>

      <!-- Rating -->
      <div class="d-flex align-items-center gap-2 mb-3">
        <div class="text-warning">
          {% for i in range(1, 6) %}
            {% if i <= product.average_rating|int %}‚≠ê
            {% else %}<span class="text-muted">‚òÜ</span>{% endif %}
          {% endfor %}
        </div>
        <span class="fw-semibold">{{ product.average_rating }}</span>
        <span class="text-muted small">({{ product.review_count }} reviews)</span>
        <span class="text-muted small">¬∑ {{ product.views }} views</span>
      </div>

      <!-- Price -->
      <div class="price-box bg-light rounded-3 p-3 mb-3">
        <span class="display-6 fw-bold text-success">‚Ç±{{ "%.2f"|format(product.price) }}</span>
        <span class="text-muted fs-5"> / {{ product.unit }}</span>
      </div>

      <!-- Details -->
      <div class="row g-2 mb-3 small">
        <div class="col-6">
          <div class="d-flex align-items-center gap-2 text-muted">
            <i class="fas fa-map-marker-alt text-success"></i>
            <span>{{ product.location or (product.farmer.region if product.farmer else 'Philippines') }}</span>
          </div>
        </div>
        <div class="col-6">
          <div class="d-flex align-items-center gap-2 text-muted">
            <i class="fas fa-box text-success"></i>
            <span>{{ product.stock_quantity }} {{ product.unit }}s available</span>
          </div>
        </div>
        {% if product.harvest_date %}
        <div class="col-6">
          <div class="d-flex align-items-center gap-2 text-muted">
            <i class="fas fa-calendar text-success"></i>
            <span>Harvested: {{ product.harvest_date.strftime('%b %d, %Y') }}</span>
          </div>
        </div>
        {% endif %}
        <div class="col-6">
          <div class="d-flex align-items-center gap-2 text-muted">
            <i class="fas fa-shopping-basket text-success"></i>
            <span>Min. order: {{ product.min_order_quantity }} {{ product.unit }}</span>
          </div>
        </div>
      </div>

      <!-- Description -->
      {% if product.description %}
      <div class="mb-3">
        <h6 class="fw-bold">Description</h6>
        <p class="text-muted">{{ product.description }}</p>
      </div>
      {% endif %}

      <!-- Add to Cart -->
      {% if product.is_in_stock %}
        {% if current_user.is_authenticated %}
        <form action="{{ url_for('cart.add_to_cart', product_id=product.id) }}" method="POST" class="d-flex gap-2 align-items-center">
          <div class="input-group" style="max-width:130px">
            <button type="button" class="btn btn-outline-secondary" onclick="changeQty(-1)">‚àí</button>
            <input type="number" class="form-control text-center" name="quantity" id="qtyInput"
                   value="{{ product.min_order_quantity }}" min="{{ product.min_order_quantity }}"
                   max="{{ product.stock_quantity }}"/>
            <button type="button" class="btn btn-outline-secondary" onclick="changeQty(1)">+</button>
          </div>
          <button type="submit" class="btn btn-success btn-lg flex-grow-1 fw-semibold">
            <i class="fas fa-cart-plus me-2"></i>Add to Cart
          </button>
        </form>
        {% else %}
        <a href="{{ url_for('auth.login') }}" class="btn btn-success btn-lg w-100 fw-semibold">
          <i class="fas fa-sign-in-alt me-2"></i>Login to Buy
        </a>
        {% endif %}
      {% else %}
      <div class="alert alert-danger">
        <i class="fas fa-times-circle me-2"></i>This product is currently out of stock.
      </div>
      {% endif %}

      <!-- Seller Info -->
      <div class="card border-0 bg-light mt-4" style="border-radius:12px">
        <div class="card-body d-flex align-items-center gap-3">
          <img src="https://ui-avatars.com/api/?name={{ product.farmer.full_name or product.farmer.username }}&background=2e7d32&color=fff&size=50"
               class="rounded-circle" width="50" height="50" alt="Farmer"/>
          <div class="flex-grow-1">
            <div class="fw-semibold">{{ product.farmer.full_name or product.farmer.username }}</div>
            <div class="text-muted small"><i class="fas fa-map-marker-alt me-1"></i>{{ product.farmer.region or 'Philippines' }}</div>
            <div class="text-warning small">
              {% for _ in range(product.farmer.average_rating|int) %}‚≠ê{% endfor %}
              <span class="text-muted">({{ product.farmer.average_rating }})</span>
            </div>
          </div>
          <a href="{{ url_for('users.farmer_store', farmer_id=product.farmer.id) }}" class="btn btn-outline-success btn-sm">
            Visit Store
          </a>
        </div>
      </div>

      <!-- Delivery info -->
      <div class="d-flex gap-3 mt-3 small text-muted">
        <span><i class="fas fa-truck text-success me-1"></i>Free delivery over ‚Ç±500</span>
        <span><i class="fas fa-shield-alt text-success me-1"></i>Buyer Protection</span>
        <span><i class="fas fa-undo text-success me-1"></i>Easy Returns</span>
      </div>
    </div>
  </div>

  <!-- Reviews Section -->
  <div class="mt-5">
    <h3 class="fw-bold mb-4">Customer Reviews</h3>
    {% if product.reviews %}
    <div class="row g-3">
      {% for review in product.reviews %}
      <div class="col-md-6">
        <div class="card border-0 shadow-sm p-3" style="border-radius:12px">
          <div class="d-flex align-items-center gap-2 mb-2">
            <img src="https://ui-avatars.com/api/?name={{ review.reviewer.username }}&background=e8f5e9&color=2e7d32&size=35"
                 class="rounded-circle" width="35" height="35"/>
            <div>
              <div class="fw-semibold small">{{ review.reviewer.full_name or review.reviewer.username }}</div>
              <div class="text-muted" style="font-size:0.7rem">{{ review.created_at.strftime('%b %d, %Y') }}</div>
            </div>
            <div class="ms-auto text-warning">
              {% for i in range(review.rating) %}‚≠ê{% endfor %}
            </div>
          </div>
          {% if review.comment %}
          <p class="text-muted small mb-0">{{ review.comment }}</p>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-4 text-muted">
      <i class="fas fa-star fa-2x mb-2 opacity-25"></i>
      <p>No reviews yet. Be the first to review this product!</p>
    </div>
    {% endif %}
  </div>

  <!-- Related Products -->
  {% if related %}
  <div class="mt-5">
    <h3 class="fw-bold mb-4">You Might Also Like</h3>
    <div class="row g-3">
      {% for p in related %}
      <div class="col-6 col-md-3">
        {% with product=p %}{% include 'products/_card.html' %}{% endwith %}
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

</div>

<script>
function changeQty(delta) {
  const input = document.getElementById('qtyInput');
  const min = parseInt(input.min) || 1;
  const max = parseInt(input.max) || 9999;
  input.value = Math.min(Math.max(parseInt(input.value) + delta, min), max);
}
</script>
{% endblock %}